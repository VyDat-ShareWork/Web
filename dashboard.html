<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>EVIBEAI - DASHBOARD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg: #f6f8fb70;
            --fg: #2c3e50;
            --card: #fff;
            --brand: #219bffb0;
            --muted: #6b7a8c;
            --success: #02ff3d;
            --success-bg: #d4edda;
            --warn: #ffca2b;
            --warn-bg: #fff3cd;
            --danger: #c40014;
            --danger-bg: #f8d7da;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            margin: 0;
            height: 100%
        }

        body {
            font-family: "Inter", "Segoe UI", Arial, sans-serif;
            background: var(--bg);
            color: var(--fg)
        }

        header {
            background: var(--brand);
            color: #fff;
            padding: 14px 16px;
            text-align: center;
            font-weight: 600;
            letter-spacing: .3px
        }

        .page {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
            display: grid;
            gap: 16px
        }

        /* KPI CARDS */
        .kpis {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }

        .kpi {
            background: var(--card);
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .06)
        }

        .kpi h4 {
            margin: 0 0 6px;
            font-size: 13px;
            color: var(--muted);
            font-weight: 600
        }

        .kpi .val {
            margin: 0;
            font-size: 22px;
            font-weight: 800
        }

        /* BADGES */
        .badge {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 16px;
            font-weight: 700;
        }

        .badge.normal {
            background: var(--success-bg);
            color: var(--success)
        }

        .badge.warn {
            background: var(--warn-bg);
            color: var(--warn)
        }

        .badge.fault {
            background: var(--danger-bg);
            color: var(--danger)
        }

        /* Overview row */
        .overview-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        .overview-row .card {
            height: 340px
        }

        /* Generic card */
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .06);
            height: 320px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .card h3 {
            margin: 0 0 8px;
            font-size: 15px;
            color: #34495e
        }

        .card canvas {
            flex: 1;
            height: 100% !important
        }

        /* System status */
        .system-status {
            background: var(--card);
            border-radius: 14px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .06);
            padding: 18px;
        }

        .system-status h3 {
            margin: 0 0 12px;
            font-size: 18px;
            font-weight: 600;
            color: #34495e;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 6px 0;
            font-size: 18px
        }

        .status-row .label {
            color: var(--muted);
            font-weight: 500
        }

        /* Status color variants used inside the status box */
        .status-normal {
            background: #d4edda;
            color: #02ff3d
        }

        .status-warning {
            background: #fff3cd;
            color: #ffc002
        }

        .status-fault {
            background: #f8d7da;
            color: #ff0019
        }

        /* CHARTS GRID (single source of truth) */
        .charts {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }

        /* slightly lower card height for many-in-a-row layouts */
        .charts .card {
            height: 260px
        }

        /* TABLE */
        .table-wrap {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .06);
            overflow: auto;
            /* horizontal scroll on small screens */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 760px
        }

        thead th {
            background: var(--brand);
            color: #fff;
            text-align: left;
            padding: 10px;
            position: sticky;
            top: 0
        }

        tbody td {
            padding: 10px;
            border-top: 1px solid #edf0f4
        }

        tbody tr:nth-child(even) {
            background: #fafbfd
        }

        /* BREAKPOINTS */
        @media (max-width: 1200px) {
            .overview-row {
                grid-template-columns: 3fr 2fr
            }
        }

        @media (max-width: 1024px) {
            .overview-row {
                grid-template-columns: 1fr
            }

            .overview-row .card {
                height: 300px
            }

            .charts .card {
                height: 280px
            }
        }

        @media (max-width: 768px) {
            header {
                padding: 12px
            }

            .page {
                padding: 12px
            }

            .charts .card {
                height: 260px
            }
        }

        @media (max-width: 480px) {
            .charts .card {
                height: 240px
            }
        }
    </style>
</head>

<body>
<header><br>EVIBEAI - DASHBOARD</header>

    <main class="page">
        <section class="kpis">
            <div class="kpi">
                <h4>RMS</h4>
                <p class="val" id="kpiRms">--</p>
            </div>
            <div class="kpi">
                <h4>Peak</h4>
                <p class="val" id="kpiPeak">--</p>
            </div>
            <div class="kpi">
                <h4>Crest Factor</h4>
                <p class="val" id="kpiCrest">--</p>
            </div>
            <div class="kpi">
                <h4>Confidence</h4>
                <p class="val" id="kpiConf">-- %</p>
            </div>
            <div class="kpi">
                <h4>Status</h4>
                <p class="val"><span id="kpiStatus" class="badge">--</span></p>
            </div>
        </section>

        <section class="overview-row">
            <div class="card">
                <h3>Dominant Frequencies</h3>
                <canvas id="freqChart"></canvas>
            </div>
            <div class="system-status">
                <h3>System Status</h3>
                <div class="status-row"><span class="label">Status:</span><span id="statusText" class="badge">--</span>
                </div>
                <div class="status-row"><span class="label">Confidence:</span><span id="confText">--</span></div>
                <div class="status-row"><span class="label">Time:</span><span id="timeText">--</span></div>
                <div class="status-row"><span class="label">Samples:</span><span id="sampleText">--</span></div>
                <div class="status-row"><span class="label">Timestamp:</span><span id="tsText">--</span></div>
                <div class="status-row"><span class="label">Dominant Frequencies:</span><span id="freqText">--</span>
                </div>
            </div>
        </section>

        <!-- Only use .charts (grid). Removed charts-row (flex) to avoid conflicts -->
        <section class="charts">
            <div class="card">
                <h3>RMS Trend</h3><canvas id="rmsChart"></canvas>
            </div>
            <div class="card">
                <h3>Peak Trend</h3><canvas id="peakChart"></canvas>
            </div>
            <div class="card">
                <h3>Peak-to-Peak Trend</h3><canvas id="p2pChart"></canvas>
            </div>
            <div class="card">
                <h3>Crest Factor Trend</h3><canvas id="crestChart"></canvas>
            </div>
        </section>

        <section class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>RMS</th>
                        <th>Peak</th>
                        <th>Peak-to-Peak</th>
                        <th>Crest Factor</th>
                        <th>Status</th>
                        <th>Confidence (%)</th>
                    </tr>
                </thead>
                <tbody id="overviewBody"></tbody>
            </table>
        </section>
    </main>

    <script>
        function makeLine(ctx, border, fill) {
            return new Chart(ctx, {
                type: "line",
                data: { labels: [], datasets: [{ data: [], borderColor: border, backgroundColor: fill, fill: "origin", tension: .25 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: { legend: { display: false }, decimation: { enabled: true, algorithm: "min-max", samples: 120 } },
                    scales: { x: { display: true }, y: { beginAtZero: true } }
                }
            });
        }

        const rmsChart = makeLine(document.getElementById("rmsChart"), "rgba(0,123,255,1)", "rgba(0,123,255,.15)");
        const peakChart = makeLine(document.getElementById("peakChart"), "rgba(255,99,132,1)", "rgba(255,99,132,.15)");
        const p2pChart = makeLine(document.getElementById("p2pChart"), "rgba(40,167,69,1)", "rgba(40,167,69,.15)");
        const crestChart = makeLine(document.getElementById("crestChart"), "rgba(153,102,255,1)", "rgba(153,102,255,.15)");

        const freqChart = new Chart(document.getElementById("freqChart"), {
            type: "bar",
            data: { labels: [], datasets: [{ data: [], label: "Magnitude", backgroundColor: "#f8b55d", barPercentage: 0.4, categoryPercentage: 0.6 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        const MAX_POINTS = 60;
        function pushPoint(chart, x, y) {
            chart.data.labels.push(x);
            chart.data.datasets[0].data.push(y);
            if (chart.data.labels.length > MAX_POINTS) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
        }

        const el = id => document.getElementById(id);
        function setStatusBadge(text) {
            const b = el("kpiStatus"); b.textContent = text || "--";
            b.className = "badge " + (text === "Normal" ? "normal" : (text === "Warning" ? "warn" : "fault"));
        }
        function addOverviewRow(d) {
            const tbody = el("overviewBody"); const tr = document.createElement("tr");
            tr.innerHTML = `
      <td data-label="Timestamp">${d.timestamp || "--"}</td>
      <td data-label="RMS">${fmt(d.rms)}</td>
      <td data-label="Peak">${fmt(d.peak)}</td>
      <td data-label="Peak-to-Peak">${fmt(d.peak_to_peak)}</td>
      <td data-label="Crest Factor">${fmt(d.crest_factor)}</td>
      <td data-label="Status">${d.status || "--"}</td>
      <td data-label="Confidence (%)">${d.confident != null ? (d.confident * 100).toFixed(1) : "--"}</td>`;
            tbody.prepend(tr); while (tbody.rows.length > 50) tbody.deleteRow(-1);
        }
        const fmt = v => (v == null ? "--" : Number(v).toFixed(3));
        let tick = 0;

        /* ------------------------------
           CÁCH 1: Data thực từ HiveMQ
           ------------------------------ */
        const brokerUrl = "wss://de6686b6c05c4c2985ed2a5c67d01b2c.s1.eu.hivemq.cloud:8884/mqtt";
        const options = { username: "hieuvm", password: "Hieu1234@!", protocol: "wss" };
        const client = mqtt.connect(brokerUrl, options);

        client.on("connect", () => { console.log("Connected to HiveMQ Cloud"); client.subscribe("#"); });
        client.on("message", (_topic, msg) => {
            try { const data = JSON.parse(msg.toString()); tick++; updateChartsAndUI(data); }
            catch (e) { console.error("Parse error:", e); }
        });

        /* ------------------------------
           CÁCH 2: Fake data (chạy test)
           ------------------------------ */
        // setInterval(() => {
        //     tick++;
        //     const data = {
        //         timestamp: new Date().toLocaleString(),
        //         rms: Math.random() * 2, peak: Math.random() * 5, peak_to_peak: Math.random() * 10, crest_factor: Math.random() * 3,
        //         status: ["Normal", "Warning", "Fault"][Math.floor(Math.random() * 3)],
        //         confident: Math.random(),
        //         dominant_frequencies: [10, 20, 30, 40].map(f => f + Math.random() * 2),
        //         frequency_magnitudes: [Math.random() * 5, Math.random() * 3, Math.random() * 4, Math.random() * 2]
        //     };
        //     updateChartsAndUI(data);
        // }, 1000);

        function updateChartsAndUI(data) {
            pushPoint(rmsChart, tick, data.rms);
            pushPoint(peakChart, tick, data.peak);
            pushPoint(p2pChart, tick, data.peak_to_peak);
            pushPoint(crestChart, tick, data.crest_factor);
            rmsChart.update(); peakChart.update(); p2pChart.update(); crestChart.update();

            if (Array.isArray(data.dominant_frequencies) && Array.isArray(data.frequency_magnitudes)) {
                freqChart.data.labels = data.dominant_frequencies.map(f => Number(f).toFixed(1));
                freqChart.data.datasets[0].data = data.frequency_magnitudes;
                freqChart.update();
            }

            const statusEl = el("statusText");
            const statusVal = data.status || "--";
            statusEl.textContent = statusVal;
            statusEl.className = "badge"; // reset
            if (statusVal === "Normal") { statusEl.classList.add("status-normal"); }
            else if (statusVal === "Warning") { statusEl.classList.add("status-warning"); }
            else { statusEl.classList.add("status-fault"); }

            el("kpiRms").textContent = fmt(data.rms);
            el("kpiPeak").textContent = fmt(data.peak);
            el("kpiCrest").textContent = fmt(data.crest_factor);
            el("kpiConf").textContent = data.confident != null ? (data.confident * 100).toFixed(1) + " %" : "--";
            setStatusBadge(data.status);

            el("confText").textContent = (data.confident != null ? (data.confident * 100).toFixed(1) : "--") + "%";
            el("timeText").textContent = tick + "s";
            el("sampleText").textContent = tick;
            el("tsText").textContent = (data.timestamp || new Date().toLocaleString());
            if (data.dominant_frequencies) {
                el("freqText").textContent = data.dominant_frequencies.map(f => Number(f).toFixed(1)).join(", ") + " Hz";
            }
            addOverviewRow(data);
        }
    </script>
</body>

</html>